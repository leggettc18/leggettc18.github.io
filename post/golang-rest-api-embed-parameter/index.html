<!DOCTYPE html>
<html lang='en-us'>
    <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Golang REST API Tip - Use an Embed Parameter to Embed Related Resources - Christopher Leggett</title>
    <meta property="og:title" content="Golang REST API Tip - Use an Embed Parameter to Embed Related Resources - Christopher Leggett" />
    <meta name="twitter:card" content="summary" />
    <meta name="description" content="A practical example demonstrating how to handle an embed parameter in a Golang REST API to embed or preload related resources." />
    <meta property="og:description" content="A practical example demonstrating how to handle an embed parameter in a Golang REST API to embed or preload related resources." />
    
    <meta name="author" content="Christopher Leggett" />
    <meta name="twitter:creator" content="@leggettc18" />
    <meta name="generator" content="Hugo 0.86.0" />

    
    
    
    
    
    
    <link rel="stylesheet" href="/css/styles.css" integrity="">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <meta property="og:image" content="https://chrisleggett.me/me.jpg" />
</head>
    <body class="flex flex-col min-h-screen bg-gray-100"><header class="w-full px-4 py-2 bg-black">
    
    <style type="text/css">
        input#nav-toggle:checked~label#show-button {
            display: none;
        }

        input#nav-toggle:checked~label#hide-button {
            display: flex;
        }

        input#nav-toggle:checked~#nav-menu {
            display: block;
        }
    </style>

    <nav class="flex items-center justify-between flex-wrap">
        <a href="https://chrisleggett.me/" class="flex items-center text-gray-500 hover:text-purple-400 font-bold">
            Christopher Leggett
        </a>

        <input id="nav-toggle" type=checkbox class="hidden">
        <label id="show-button" for="nav-toggle"
            class="flex items-center block sm:hidden text-gray-400 hover:text-purple-400">
            <svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <title>Menu Open</title>
                <path d="M0 3h20v2H0V3z m0 6h20v2H0V9z m0 6h20v2H0V0z" />
            </svg>
        </label>
        <label id="hide-button" for="nav-toggle" class="flex items-center hidden text-gray-600 hover:text-purple-500">
            <svg class="fill-current h-4 w-4" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <title>Menu Close</title>
                <polygon points="11 9 22 9 22 11 11 11 11 22 9 22 9 11 -2 11 -2 9 9 9 9 -2 11 -2"
                    transform="rotate(45 10 10)" />
            </svg>
        </label>

        <ul id="nav-menu" class="sm:flex w-full sm:w-auto hidden sm:block mt-2 sm:mt-0 sm:space-x-2">
            
            <li>
                <a href="https://chrisleggett.me/about/" class="text-gray-400 hover:text-purple-400">About</a>
            </li>
            
            
            <li>
                <a href="https://chrisleggett.me/post/" class="text-gray-400 hover:text-purple-400">Posts</a>
            </li>
            
            <li>
                <a href="https://chrisleggett.me/projects/" class="text-gray-400 hover:text-purple-400">Projects</a>
            </li>
            
        </ul>
    </nav>
</header><main class="flex-1">
<article class="text-gray-700 sm:mx-12 wrapper mx-4 md:mx-12 lg:mx-48 lg:px-48 sm:mt-16">
        <h1 class="font-bold text-3xl text-gray-700 text-center p-4">Golang REST API Tip - Use an Embed Parameter to Embed Related Resources</h1>
    <div class="full-bleed border-b">
    </div>
    
    <p>In a REST API, you often have relations between resources. While you can certainly
return IDs for these related objects and require the API consumer to query them,
that can be somewhat inconvenient for your users. On the other hand, you certainly
don&rsquo;t want to eagerly load these on every request, or you could be sending
unnecessarily large payloads in your responses. So what can you do?</p>
<p>In my case, I chose to support a query parameter with the name <code>embed</code>. Semantically,
the logic is that we are &ldquo;embedding&rdquo; the related resource in the response for
the resource requested by the path. For example, in a bookmark management app,
you may be requesting a folder and embed the bookmarks in the folder
with the following URL.</p>
<pre><code>&lt;baseUrl&gt;/folders/&lt;id&gt;/?embed=bookmarks
</code></pre><p>With that, you would receive a response body similar to the following:</p>
<pre><code>{
    &quot;id&quot;: 1,
    &quot;name&quot;: &quot;folder&quot;,
    &quot;bookmarks&quot;: [
        {
            &quot;id&quot;: 1,
            &quot;name&quot;: &quot;My Website&quot;,
            &quot;url&quot;: &quot;https://chrisleggett.me&quot;
        },
        {
            &quot;id&quot;: 2,
            &quot;name&quot;: &quot;Devmarks Demo&quot;,
            &quot;url&quot;: &quot;https://demo.devmarks.app&quot;
        }
    ]
}
</code></pre><p>Side Note: I picked the word &ldquo;embed&rdquo; here, but there is no standard around this.
It would be just as valid for you to choose &ldquo;preload&rdquo; or &ldquo;include&rdquo;. As long
as your choice is documented with the rest of your api documentation, it
ultimately doesn&rsquo;t matter.</p>
<p>Now how would you actually implement this? Below I will provide some code excerpts
that show how I chose to implement this. My examples below use <code>gorilla/mux</code> for
routing, and <code>gorm</code> for database access via an ORM, but with some light modification
this concept should be able to be implemented with other libraries as well.
Additionally, I do not claim that I am the first to come up with this, nor do
I claim that this is the only way or even the best way to accomplish this.</p>
<p>First off, I recommend extracting the embed query parameter from the URL and
saving it in the context via middleware so it can be pulled out of the context
later in any method down the line. As such, we need to setup a key for the
context to use for storing and retrieving the embed values. I define this
in a separate helpers package in order to avoid cyclical imports.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#75715e">// helpers/ctx.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">helpers</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">contextKey</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>
}
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">EmbedsKey</span> = <span style="color:#a6e22e">contextKey</span>{<span style="color:#e6db74">&#34;embeds&#34;</span>}

<span style="color:#75715e">// Wherever you choose to define this middleware
</span><span style="color:#75715e"></span><span style="color:#f92672">...</span>
<span style="color:#f92672">import</span> &lt;<span style="color:#a6e22e">project_url</span>&gt;<span style="color:#f92672">/</span><span style="color:#a6e22e">helpers</span>
<span style="color:#f92672">...</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">apiMiddleware</span>(<span style="color:#a6e22e">next</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span>) <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Handler</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandlerFunc</span>(<span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
		<span style="color:#a6e22e">values</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">URL</span>.<span style="color:#a6e22e">Query</span>()
		<span style="color:#a6e22e">embeds</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Split</span>(<span style="color:#a6e22e">values</span>.<span style="color:#a6e22e">Get</span>(<span style="color:#e6db74">&#34;embed&#34;</span>), <span style="color:#e6db74">&#34;,&#34;</span>)
		<span style="color:#a6e22e">ctx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Context</span>()
		<span style="color:#a6e22e">ctx</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">helpers</span>.<span style="color:#a6e22e">EmbedsKey</span>, <span style="color:#a6e22e">embeds</span>)
		<span style="color:#a6e22e">next</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">WithContext</span>(<span style="color:#a6e22e">ctx</span>))
		
	})
}
</code></pre></div><p>As you can see, the helpers package defines a contextKey struct and defines an
exported instance of that key called <code>EmbedsKey</code>. Wherever we define our middleware,
we then import the helpers package and use the <code>EmbedsKey</code> to save an array of
strings that we extracted from the <code>embeds</code> query parameter. We then move onto
our next middleware/final handler passing in the <code>ResponseWriter</code> and the <code>Request</code>
object with our modifed context inside.</p>
<p>Make sure you use the middleware in your router.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#f92672">import</span> 	<span style="color:#e6db74">&#34;github.com/gorilla/mux&#34;</span>

<span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">mux</span>.<span style="color:#a6e22e">NewRouter</span>()
<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Use</span>(<span style="color:#a6e22e">apiMiddleware</span>)
<span style="color:#75715e">// your routes and handlers here
</span></code></pre></div><p>Next, your request goes through your handler and eventually makes it to your
database code. Make sure your handler function extracts the context from the
<code>Request</code> (<code>ctx := r.Context())</code> and then passes it down to your database handling package.
This is where I extract the embeds array we saved in the context
earlier. GORM has a <code>Preload</code> function that we can use to preload associations
defined in your models. However, you need some way to validate the embed values
to make sure they are valid associations in your database, as there&rsquo;s nothing
stopping an api consumer from putting anything at all in the embeds value.</p>
<p>To start off with, let&rsquo;s wrap the logic around setting up the <code>*gorm.DB</code> instance
with the preloads.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">db</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Database</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span>
}

<span style="color:#75715e">// You should probably put this in your helpers function, I have it here for clarity.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">contains</span>(<span style="color:#a6e22e">array</span> []<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">x</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">array</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">x</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">s</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">db</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Database</span>) <span style="color:#a6e22e">preloadEmbeds</span>(<span style="color:#a6e22e">valid</span> []<span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">embeds</span> []<span style="color:#66d9ef">string</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">gorm</span>.<span style="color:#a6e22e">DB</span> {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">instance</span> = <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">DB</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">embed</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">embeds</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">contains</span>(<span style="color:#a6e22e">valid</span>, <span style="color:#a6e22e">embed</span>) {
			<span style="color:#a6e22e">instance</span> = <span style="color:#a6e22e">instance</span>.<span style="color:#a6e22e">Preload</span>(<span style="color:#a6e22e">strings</span>.<span style="color:#a6e22e">Title</span>(<span style="color:#a6e22e">embed</span>))
		}
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">instance</span>
}
</code></pre></div><p>This function takes an array of valid embed values and the ones that were
provided in the request. It then returns an instance of <code>*gorm.DB</code> with the
Preloads prepared. It currently just ignores any invalid embed values that are
provided. If no embed values are provided, then it simply returns the same <code>*gorm.DB</code>
instance it was called on. As this returns a <code>*gorm.DB</code>, we can immediately chain a <code>First()</code> or
<code>Find()</code> method, for instance, off of this function. For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Go" data-lang="Go"><span style="color:#75715e">// db/folder.go
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">db</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Database</span>) <span style="color:#a6e22e">GetFolderByID</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">id</span> <span style="color:#66d9ef">uint</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Folder</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">folder</span> <span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">Folder</span>
	<span style="color:#a6e22e">embeds</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Value</span>(<span style="color:#a6e22e">helpers</span>.<span style="color:#a6e22e">EmbedsKey</span>).([]<span style="color:#66d9ef">string</span>)
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;embeds parsing error&#34;</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">folder</span>, <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">preloadEmbeds</span>(<span style="color:#a6e22e">model</span>.<span style="color:#a6e22e">FolderValidEmbeds</span>(), <span style="color:#a6e22e">embeds</span>).
        <span style="color:#a6e22e">First</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">folder</span>, <span style="color:#a6e22e">id</span>).<span style="color:#a6e22e">Error</span>, <span style="color:#e6db74">&#34;unable to get folder&#34;</span>)
}

<span style="color:#75715e">// model/folder.go
</span><span style="color:#75715e"></span><span style="color:#f92672">package</span> <span style="color:#a6e22e">model</span>

<span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Folder</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">ID</span>    <span style="color:#66d9ef">uint</span> <span style="color:#e6db74">`json:&#34;id&#34;`</span>
	<span style="color:#a6e22e">Name</span>  <span style="color:#66d9ef">string</span> <span style="color:#e6db74">`json:&#34;name&#34;`</span>

	<span style="color:#a6e22e">Bookmarks</span> []<span style="color:#a6e22e">Bookmark</span> <span style="color:#e6db74">`gorm:&#34;many2many:bookmark_folder;&#34; json:&#34;bookmarks&#34;`</span>
}

<span style="color:#75715e">// Add strings to the array to allow embedding that resource through the
</span><span style="color:#75715e">// embed query paramter.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">FolderValidEmbeds</span>() []<span style="color:#66d9ef">string</span> {
	<span style="color:#66d9ef">return</span> []<span style="color:#66d9ef">string</span>{<span style="color:#e6db74">&#34;bookmarks&#34;</span>}
}
</code></pre></div><p>Unfortunately Go does not have a good equivalent to static methods, so the next
best thing is to define a namespaced exported function in the models package
that returns an array of strings which represent the list of valid embed values.
I named this one <code>FolderValidEmbeds</code>. If later on we develop a relationship
between Bookmarks and Tags and we want to provide embed support for it, for example,
you would need to define a similar function called <code>BookmarkValidEmbeds</code> that returns
an array of strings containing <code>&quot;tags&quot;</code>.</p>
<p>At this point, your API handler should write out the returned object as json
to your api consumer. If you wish to see this in practice, check out my open source
bookmark manager api. It is still in active development, but besides some minor
reorganization this idea probably won&rsquo;t change. Check it out <a href="https://github.com/leggettc18/devmarks/tree/main/api">here</a>!</p>

</article>

        </main><footer class="w-full text-center border-t border-gray-200 p-4 pin-b text-xs text-gray-400">
    <div class="flex items-center justify-between">
        <img src="giraffe.svg" alt="giraffe" class="w-6 mr-2">
        <p>made with <a href="https://gohugo.io" class="underline hover:text-blue-400">Hugo</a> and <a href="https://tailwindcss.com" class="underline hover:text-blue-400">TailwindCSS</a></p>
        <div class="flex items-center">
            <svg class="w-6 h-6 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            <a href="mailto:chris@leggett.dev">chris@leggett.dev</a>
        </div>
    </div>
</footer></body>
</html>
